<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文件上传与版本管理</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<style>
body {
  background-color: #212121;
  color: #ffffff;
}
.client-status {
  border-radius: 5px;
  background-color: #3c4137;
}
.row-ex {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2px;
  padding: 0 5px
}
.status-ok {
  background-color: #5d9e6d;
}
.status-warning {
  background-color: #23332c;
}
.clients-container {
  display: flex;
  flex-direction: column;
  width: 700px;
}
.file-list{
  margin-left: 10px;
}
.hover-effect:hover {
  background-color: #24685c;
}
</style>
</head>
<body>
<div class="container">
  <h4>多端文件版本管理</h4>
  <div class="col s12 m6">
    <h5>关联机器</h5>
    <ul id="client-list" class="clients-container"></ul>

    <h5>文件上传</h5>
    <div class="row" style="margin-left: 5px;">
      <button id="upload-btn" class="btn waves-effect waves-light">上传文件</button>
      <button id="update-version-btn" class="btn waves-effect waves-light">更新版本</button>
    </div>
    <ul id="file-list" class="file-list"></ul>
  </div>
</div>

<script>
  const clientListElement = document.getElementById('client-list');
  const fileInput = document.getElementById('file-input');
  const uploadBtn = document.getElementById('upload-btn');
  const updateVersionBtn = document.getElementById('update-version-btn');
  const fileListElement = document.getElementById('file-list');
  const cachedFiles = [];

  async function fetchClients() {
    const response = await fetch('/clients');
    const clients = await response.json();
    const now = new Date();

    clientListElement.innerHTML = '';
    for (const [client, timestamp] of Object.entries(clients)) {
      const clientTime = new Date(timestamp);

      const li = document.createElement('li');
      li.classList.add('client-status', 'row-ex');
      li.innerHTML = `<span>${client}</span> <span>${timestamp.split('.')[0]}</span>`;
      const timeDiff = (now - clientTime) / 1000 / 60; // 转换为分钟
      if (timeDiff > 5) {
          li.classList.add('status-warning');
      } else {
          li.classList.add('status-ok');
      }
      clientListElement.appendChild(li);
    }
  }

  function updateFileListView() {
    fileListElement.innerHTML = '';
    cachedFiles.forEach((file, index) => {
      const li = document.createElement('li');
      li.classList.add('row-ex', 'hover-effect');
      li.textContent = file.name;
      const removeBtn = document.createElement('div');
      removeBtn.style.cursor = 'pointer';
      removeBtn.textContent = 'X';
      removeBtn.onclick = () => {
        cachedFiles.splice(index, 1);
        updateFileListView();
      };
      li.appendChild(removeBtn);
      fileListElement.appendChild(li);
    });
  }

  let tmpInput = null;
  function selectFiles() {
    if(tmpInput) tmpInput.remove();
    tmpInput = document.createElement('input');
    tmpInput.style.position = 'fixed';
    tmpInput.style.opacity = 0;
    tmpInput.type = 'file';
    tmpInput.multiple = true;
    tmpInput.onchange = (event) => {
      const files = Array.from(event.target.files);
      if (files && files.length > 0) {
        cachedFiles.push(...files);
        updateFileListView();
      }
      tmpInput.remove();
      tmpInput = null;
    }
    document.body.appendChild(tmpInput);
    tmpInput.click();
  }

  async function postFiles() {
    if (cachedFiles.length === 0) {
      console.log('没有文件需要上传');
      return false;
    }
    const len = cachedFiles.length;
    for(var i=0; i<len; i++){
      file = cachedFiles.pop();

      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const result = await response.text();
      console.log('上传 '+file.name, result);
      updateFileListView()  // 更新文件列表显示
    }
    fetchClients(); // 更新客户端信息
    return true
  }

  async function updateVersion() {
    console.log('开始更新版本')
    const status_ok = await postFiles();
    if (!status_ok) return;

    const response = await fetch('/update_version');
    const result = await response.json();
    console.log('版本已更新:', result.version);
    alert('版本已更新:'+result.version);
    fetchClients(); // 更新客户端信息
  }

  uploadBtn.onclick = selectFiles;
  updateVersionBtn.onclick = updateVersion;

  // 初始化客户端信息
  fetchClients();
  setInterval(fetchClients, 30000); // 每30秒更新一次客户端信息
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>